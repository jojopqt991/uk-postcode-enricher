<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Postcodes.io CSV Enricher</title>
  <style>
    :root {
      --bg: #f5f6f8;
      --panel: #ffffff;
      --muted: #5f6470;
      --text: #0b0c10;
      --accent: #3a7cff;
      --border: #e3e6ef;
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      line-height: 1.45;
    }
    header { padding: 28px 20px 10px; text-align: center; }
    h1 { margin: 0; font-size: 22px; letter-spacing: 0.3px; }
    .sub { color: var(--muted); font-size: 14px; margin-top: 6px; }
    main { max-width: 800px; margin: 0 auto; padding: 20px; display: grid; gap: 16px; }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; }
    textarea {
      width: 100%; min-height: 180px; resize: vertical;
      background: #ffffff; color: var(--text); border: 1px solid var(--border);
      border-radius: 12px; padding: 12px; font: inherit;
    }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .btn {
      border: 1px solid var(--border); background: #ffffff; color: var(--text);
      padding: 10px 14px; border-radius: 12px; cursor: pointer; font-weight: 600;
    }
    .btn.primary { background: var(--accent); color: #ffffff; border: 1px solid var(--accent); }
    .chip { display: inline-flex; gap: 8px; align-items: center; padding: 7px 10px; border-radius: 999px; border: 1px solid var(--border); color: var(--muted); }
    .small { font-size: 12px; color: var(--muted); }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 10px; border-bottom: 1px solid var(--border); text-align: left; font-size: 13px; color: #1f2430; }
    th { color: #1f2430; position: sticky; top: 0; background: #f0f3f8; z-index: 1; }
    .scroll { max-height: 360px; overflow: auto; border: 1px solid var(--border); border-radius: 12px; background: #ffffff; }
  </style>
</head>
<body>
  <header>
    <h1>Postcode Enricher</h1>
    <div class="sub">Paste postcodes, enrich data, preview, and download CSV.</div>
  </header>

  <main>
    <section class="card">
      <h3>Paste postcodes</h3>
      <div class="small">Enter one per line or comma-separated. Duplicates removed automatically.</div>
      <textarea id="input" placeholder="N16 9PU\nEC1M 4EH\nW1F 8SX"></textarea>
      <div class="row">
        <button class="btn" id="demo">Demo data</button>
        <span class="chip"><span id="count">0</span> unique postcodes</span>
        <button class="btn" id="clear">Clear</button>
      </div>
    </section>

    <section class="card">
      <h3>Enrich & export</h3>
      <div class="row" style="margin-bottom:10px">
        <button class="btn primary" id="run">Enrich data</button>
        <button class="btn" id="download" disabled>Download CSV</button>
        <span class="small" id="status"></span>
      </div>
      <div class="scroll" id="tableWrap" style="display:none">
        <table id="table"></table>
      </div>
    </section>
  </main>

  <script>
    const API_URL = "https://api.postcodes.io/postcodes";
    const MAX_BATCH = 100;

    const FIELDS = [
      "country",
      "nhs_ha",
      "admin_county",
      "admin_district",
      "admin_ward",
      "parliamentary_constituency",
      "european_electoral_region",
      "primary_care_trust",
      "region",
      "parish",
      "latitude",
      "longitude"
    ];

    const el = (q) => document.querySelector(q);
    const input = el('#input');
    const count = el('#count');
    const runBtn = el('#run');
    const downloadBtn = el('#download');
    const tableWrap = el('#tableWrap');
    const tableEl = el('#table');
    const statusEl = el('#status');

    function parsePostcodes(raw) {
      const normalize = (s) => {
        const compact = s.toUpperCase().replace(/[^A-Z0-9]/g, '');
        if (compact.length < 5 || compact.length > 8) return '';
        return compact.replace(/^(.*\d)([A-Z]{2})$/, '$1 $2');
      };
      const tokens = raw
        .replace(/,/g, '\n')
        .split(/\r?\n/)
        .map(s => normalize(s.trim()))
        .filter(Boolean);
      const seen = new Set();
      const out = [];
      for (const pc of tokens) {
        if (!seen.has(pc)) { seen.add(pc); out.push(pc); }
      }
      return out;
    }

    function updateCount() {
      const pcs = parsePostcodes(input.value);
      count.textContent = pcs.length;
    }

    input.addEventListener('input', updateCount);
    el('#clear').addEventListener('click', () => { input.value = ''; updateCount(); });
    el('#demo').addEventListener('click', () => {
      input.value = [
        'N16 9PU','N16 9PX','EC1M 4EH','N1 2LH','N1 1QP','N1 9EZ','EC1V 2PN','W1F 8SX','SW3 6NT','WC2H 9PJ'
      ].join('\n');
      updateCount();
    });

    async function fetchBatch(postcodes) {
      const body = { postcodes };
      const resp = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      if (!resp.ok) throw new Error(`API ${resp.status}`);
      const data = await resp.json();
      return data.result || [];
    }

    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    async function enrich(postcodes) {
      const rows = [];
      for (let i = 0; i < postcodes.length; i += MAX_BATCH) {
        const chunk = postcodes.slice(i, i + MAX_BATCH);
        statusEl.textContent = `Fetching ${i + 1}-${Math.min(i + MAX_BATCH, postcodes.length)} of ${postcodes.length}…`;
        let result;
        for (let attempt = 0; attempt < 3; attempt++) {
          try {
            result = await fetchBatch(chunk);
            break;
          } catch (e) {
            statusEl.textContent = `Rate limited / error, retrying… (${attempt + 1})`;
            await sleep(750 * (attempt + 1));
          }
        }
        if (!result) throw new Error('Failed to fetch after retries');
        for (const item of result) {
          const res = item.result;
          const row = { postcode: (res?.postcode || item.query || '').toUpperCase() };
          for (const f of FIELDS) {
            let v = res ? (res[f] ?? '') : '';
            if (v == null) v = '';
            row[f] = v;
          }
          rows.push(row);
        }
        await sleep(80);
      }
      statusEl.textContent = `Done. ${rows.length} rows.`;
      return rows;
    }

    function toCSV(rows, header) {
      const esc = (s) => {
        if (s == null) return '';
        const str = String(s);
        return /[",\n]/.test(str) ? `"${str.replace(/"/g, '""')}"` : str;
      };
      const lines = [header.join(',')];
      for (const r of rows) {
        lines.push(header.map(h => esc(r[h])).join(','));
      }
      return lines.join('\n');
    }

    function renderTable(rows, header) {
      if (!rows.length) { tableWrap.style.display = 'none'; return; }
      tableWrap.style.display = 'block';
      tableEl.innerHTML = '';
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      header.forEach(h => {
        const th = document.createElement('th'); th.textContent = h; trh.appendChild(th);
      });
      thead.appendChild(trh);
      tableEl.appendChild(thead);
      const tbody = document.createElement('tbody');
      rows.slice(0, 500).forEach(r => {
        const tr = document.createElement('tr');
        header.forEach(h => {
          const td = document.createElement('td'); td.textContent = r[h] ?? ''; tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      tableEl.appendChild(tbody);
    }

    function download(name, url) {
      const a = document.createElement('a');
      a.href = url; a.download = name; document.body.appendChild(a); a.click();
      setTimeout(() => { a.remove(); }, 0);
    }

    runBtn.addEventListener('click', async () => {
      const pcs = parsePostcodes(input.value);
      updateCount();
      if (!pcs.length) { statusEl.textContent = 'Please paste at least one postcode.'; return; }
      const header = ['postcode', ...FIELDS];
      runBtn.disabled = true; downloadBtn.disabled = true; statusEl.textContent = 'Starting…';
      try {
        const rows = await enrich(pcs);
        renderTable(rows, header);
        const csv = toCSV(rows, header);
        const ts = new Date().toISOString().replace(/[:T]/g, '-').slice(0,19);
        if (downloadBtn.dataset.url) { try { URL.revokeObjectURL(downloadBtn.dataset.url); } catch (_) {} }
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        downloadBtn.dataset.url = url;
        downloadBtn.dataset.filename = `postcodes_enriched_${ts}.csv`;
        downloadBtn.disabled = false;
        statusEl.textContent = `Ready to download (${rows.length} rows).`;
      } catch (e) {
        console.error(e);
        statusEl.textContent = 'Error fetching data. See console for details.';
      } finally {
        runBtn.disabled = false;
      }
    });

    downloadBtn.addEventListener('click', () => {
      const name = downloadBtn.dataset.filename || 'postcodes_enriched.csv';
      const url = downloadBtn.dataset.url;
      if (!url) return;
      download(name, url);
    });

    updateCount();
  </script>
</body>
</html>
